// Structure pour stocker l'historique des correspondances
function saveMatchHistory(company1Email, company2Email, matchDetails) {
    // R√©cup√©rer l'historique existant
    const matchHistory = JSON.parse(localStorage.getItem('matchHistory') || '[]');
    
    // Cr√©er l'objet de match
    const matchEntry = {
        company1Email: company1Email,
        company2Email: company2Email,
        details: matchDetails,
        date: new Date().toISOString(),
        isNew: true // Marquer comme nouveau match
    };
    
    // V√©rifier si ce match existe d√©j√† dans l'historique
    const existingMatchIndex = matchHistory.findIndex(match => 
        (match.company1Email === company1Email && match.company2Email === company2Email) ||
        (match.company1Email === company2Email && match.company2Email === company1Email)
    );
    
    // Si le match existe d√©j√†, le supprimer (nous le remplacerons)
    if (existingMatchIndex !== -1) {
        matchHistory.splice(existingMatchIndex, 1);
    }
    
    // Ajouter le nouveau match au d√©but de l'historique
    matchHistory.unshift(matchEntry);
    
    // Marquer les anciens matches comme "non nouveaux" apr√®s 7 jours
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    
    matchHistory.forEach(match => {
        const matchDate = new Date(match.date);
        if (matchDate < sevenDaysAgo) {
            match.isNew = false;
        }
    });
    
    // Sauvegarder l'historique mis √† jour
    localStorage.setItem('matchHistory', JSON.stringify(matchHistory));
}

// Fonction pour trouver les correspondances pour une entreprise
function findMatchesForCompany(companyEmail, updateHistory = true) {
    const companies = JSON.parse(localStorage.getItem('companies') || '[]');
    const currentCompany = companies.find(c => c.email === companyEmail);
    
    if (!currentCompany) return [];
    
    let matches = [];
    
    // Parcourir toutes les autres entreprises
    companies.forEach(company => {
        if (company.email === companyEmail) return; // Ignorer l'entreprise actuelle
        
        let hasMatch = false;
        let matchDetails = {
            theyProvide: [],  // Ce qu'ils peuvent nous fournir
            weProvide: []     // Ce que nous pouvons leur fournir
        };
        
        // V√©rifier si les besoins de l'entreprise actuelle correspondent aux ressources de l'autre entreprise
        if (currentCompany.needCategories && company.resourceCategories) {
            const commonCategories = currentCompany.needCategories.filter(cat => 
                company.resourceCategories.includes(cat)
            );
            
            if (commonCategories.length > 0) {
                hasMatch = true;
                matchDetails.theyProvide = commonCategories;
            }
        }
        
        // V√©rifier si les ressources de l'entreprise actuelle correspondent aux besoins de l'autre entreprise
        if (currentCompany.resourceCategories && company.needCategories) {
            const commonCategories = currentCompany.resourceCategories.filter(cat => 
                company.needCategories.includes(cat)
            );
            
            if (commonCategories.length > 0) {
                hasMatch = true;
                matchDetails.weProvide = commonCategories;
            }
        }
        
        // Si on a trouv√© des correspondances, ajouter √† la liste et mettre √† jour l'historique
        if (hasMatch) {
            matches.push({
                company: company,
                details: matchDetails
            });
            
            // Si demand√©, mettre √† jour l'historique
            if (updateHistory) {
                saveMatchHistory(companyEmail, company.email, matchDetails);
            }
        }
    });
    
    return matches;
}

// Fonction pour r√©cup√©rer les derniers matchs historiques (jusqu'√† 3)
function getRecentMatchHistory() {
    const matchHistory = JSON.parse(localStorage.getItem('matchHistory') || '[]');
    
    // Retourner les 3 derniers matchs qui ne sont plus marqu√©s comme nouveaux
    return matchHistory
        .filter(match => !match.isNew)
        .slice(0, 3);
}

// Fonction pour afficher les correspondances dans le profil
function displayMatches() {
    const email = localStorage.getItem('currentLoggedIn');
    if (!email) return;
    
    // Trouver les correspondances actuelles
    const currentMatches = findMatchesForCompany(email);
    
    // R√©cup√©rer l'historique des matchs r√©cents
    const recentMatchHistory = getRecentMatchHistory();
    
    // V√©rifier si la section de correspondances existe d√©j√†
    let matchesSection = document.getElementById('matches-section');
    
    // Si elle n'existe pas, la cr√©er et l'ins√©rer avant la notice de donn√©es
    if (!matchesSection) {
        // Cr√©er une section pour les correspondances
        matchesSection = document.createElement('div');
        matchesSection.id = 'matches-section';
        matchesSection.className = 'profile-section';
        
        const sectionTitle = document.createElement('h3');
        sectionTitle.textContent = 'üîÑ Correspondances d√©tect√©es';
        
        matchesSection.appendChild(sectionTitle);
        
        // Cr√©er un conteneur pour les nouveaux matchs
        const newMatchesTitle = document.createElement('h4');
        newMatchesTitle.textContent = 'üåü Nouveaux matchs';
        newMatchesTitle.style.color = '#E76F51';
        newMatchesTitle.style.marginTop = '20px';
        
        const newMatchesContainer = document.createElement('div');
        newMatchesContainer.id = 'new-matches-container';
        
        matchesSection.appendChild(newMatchesTitle);
        matchesSection.appendChild(newMatchesContainer);
        
        // Cr√©er un conteneur pour les matchs r√©cents
        const recentMatchesTitle = document.createElement('h4');
        recentMatchesTitle.textContent = 'üìã Matchs r√©cents';
        recentMatchesTitle.style.color = '#2A9D8F';
        recentMatchesTitle.style.marginTop = '30px';
        
        const recentMatchesContainer = document.createElement('div');
        recentMatchesContainer.id = 'recent-matches-container';
        
        matchesSection.appendChild(recentMatchesTitle);
        matchesSection.appendChild(recentMatchesContainer);
        
        // Ajouter √† la page
        const profileContent = document.getElementById('profileContent');
        const exportBtn = profileContent.querySelector('.export-btn');
        
        if (exportBtn) {
            profileContent.insertBefore(matchesSection, exportBtn);
        } else {
            profileContent.appendChild(matchesSection);
        }
    }
    
    // Afficher les nouveaux matchs
    const newMatchesContainer = document.getElementById('new-matches-container');
    newMatchesContainer.innerHTML = '';
    
    if (currentMatches.length === 0) {
        const noMatchesMsg = document.createElement('p');
        noMatchesMsg.textContent = 'Aucune nouvelle correspondance trouv√©e pour le moment.';
        newMatchesContainer.appendChild(noMatchesMsg);
    } else {
        // Afficher les matchs actuels
        currentMatches.forEach(match => {
            const matchCard = createMatchCard(match, true);
            newMatchesContainer.appendChild(matchCard);
        });
    }
    
    // Afficher les matchs r√©cents
    const recentMatchesContainer = document.getElementById('recent-matches-container');
    recentMatchesContainer.innerHTML = '';
    
    if (recentMatchHistory.length === 0) {
        const noHistoryMsg = document.createElement('p');
        noHistoryMsg.textContent = 'Pas d\'historique de correspondances disponible.';
        recentMatchesContainer.appendChild(noHistoryMsg);
    } else {
        // R√©cup√©rer les donn√©es des entreprises pour les matchs historiques
        const companies = JSON.parse(localStorage.getItem('companies') || '[]');
        
        recentMatchHistory.forEach(historyItem => {
            // D√©terminer quelle est l'autre entreprise
            const otherCompanyEmail = historyItem.company1Email === email ? 
                historyItem.company2Email : historyItem.company1Email;
            
            const otherCompany = companies.find(c => c.email === otherCompanyEmail);
            
            if (otherCompany) {
                // Cr√©er l'objet de match dans le format attendu par createMatchCard
                const match = {
                    company: otherCompany,
                    details: historyItem.details
                };
                
                // Cr√©er la carte de match et l'ajouter au conteneur
                const matchCard = createMatchCard(match, false, new Date(historyItem.date));
                recentMatchesContainer.appendChild(matchCard);
            }
        });
    }
}

// Fonction pour cr√©er une carte de match (utilis√©e par displayMatches)
function createMatchCard(match, isNew, matchDate) {
    const matchCard = document.createElement('div');
    matchCard.className = 'profile-section';
    matchCard.style.marginBottom = '15px';
    matchCard.style.padding = '15px';
    matchCard.style.backgroundColor = isNew ? '#FDF5E8' : '#f7f7f7';
    matchCard.style.borderLeft = isNew ? '4px solid #E76F51' : '4px solid #2A9D8F';
    
    // En-t√™te avec nom de l'entreprise et badge "Nouveau" si applicable
    const headerDiv = document.createElement('div');
    headerDiv.style.display = 'flex';
    headerDiv.style.justifyContent = 'space-between';
    headerDiv.style.alignItems = 'center';
    headerDiv.style.marginBottom = '10px';
    
    const companyName = document.createElement('h4');
    companyName.textContent = match.company.name;
    companyName.style.margin = '0';
    companyName.style.color = '#264653';
    
    headerDiv.appendChild(companyName);
    
    // Ajouter un badge "Nouveau" si c'est un nouveau match
    if (isNew) {
        const newBadge = document.createElement('span');
        newBadge.textContent = 'NOUVEAU';
        newBadge.style.backgroundColor = '#E76F51';
        newBadge.style.color = 'white';
        newBadge.style.padding = '4px 8px';
        newBadge.style.borderRadius = '4px';
        newBadge.style.fontSize = '0.8rem';
        headerDiv.appendChild(newBadge);
    } else if (matchDate) {
        // Afficher la date pour les matchs historiques
        const dateSpan = document.createElement('span');
        dateSpan.textContent = new Date(matchDate).toLocaleDateString();
        dateSpan.style.color = '#777';
        dateSpan.style.fontSize = '0.9rem';
        headerDiv.appendChild(dateSpan);
    }
    
    matchCard.appendChild(headerDiv);
    
    // Afficher ce que l'autre entreprise peut nous fournir
    if (match.details.theyProvide && match.details.theyProvide.length > 0) {
        const theyProvideTitle = document.createElement('p');
        theyProvideTitle.innerHTML = `<strong>${match.company.name} peut vous fournir :</strong>`;
        theyProvideTitle.style.marginBottom = '5px';
        
        const categoriesDiv = document.createElement('div');
        categoriesDiv.className = 'tag-container';
        categoriesDiv.style.marginBottom = '10px';
        
        match.details.theyProvide.forEach(category => {
            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.textContent = category;
            tag.style.backgroundColor = '#E9C46A';
            categoriesDiv.appendChild(tag);
        });
        
        matchCard.appendChild(theyProvideTitle);
        matchCard.appendChild(categoriesDiv);
    }
    
    // Afficher ce que nous pouvons fournir √† l'autre entreprise
    if (match.details.weProvide && match.details.weProvide.length > 0) {
        const weProvideTitle = document.createElement('p');
        weProvideTitle.innerHTML = `<strong>Vous pouvez fournir √† ${match.company.name} :</strong>`;
        weProvideTitle.style.marginBottom = '5px';
        
        const categoriesDiv = document.createElement('div');
        categoriesDiv.className = 'tag-container';
        categoriesDiv.style.marginBottom = '10px';
        
        match.details.weProvide.forEach(category => {
            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.textContent = category;
            tag.style.backgroundColor = '#2A9D8F';
            tag.style.color = 'white';
            categoriesDiv.appendChild(tag);
        });
        
        matchCard.appendChild(weProvideTitle);
        matchCard.appendChild(categoriesDiv);
    }
    
    // Bouton de contact (uniquement pour les nouveaux matchs)
    if (isNew) {
        const contactBtn = document.createElement('button');
        contactBtn.className = 'add-category-btn';
        contactBtn.textContent = `Contacter ${match.company.name}`;
        contactBtn.style.marginTop = '10px';
        contactBtn.onclick = function() {
            window.location.href = `mailto:${match.company.email}?subject=Potentielle synergie via R√©(GE)n√®re&body=Bonjour,%0A%0AJe vous contacte suite √† une correspondance identifi√©e sur la plateforme R√©(GE)n√®re.%0A%0ACordiales salutations`;
        };
        
        matchCard.appendChild(contactBtn);
    }
    
    return matchCard;
}

// Ajouter la recherche de correspondances aux fonctions existantes
const originalLoadProfileData = loadProfileData;
loadProfileData = function() {
    originalLoadProfileData();
    displayMatches();
};

// Modifier la fonction registerCompany pour afficher les correspondances apr√®s inscription
const originalRegisterCompany = registerCompany;
registerCompany = function() {
    originalRegisterCompany();
    
    // Trouver toutes les correspondances possibles pour la nouvelle entreprise
    const email = document.getElementById('email').value;
    const matches = findMatchesForCompany(email);
    
    // Si des correspondances sont trouv√©es, afficher un message
    if (matches.length > 0) {
        let matchMessage = `F√©licitations ! Nous avons trouv√© ${matches.length} correspondance${matches.length > 1 ? 's' : ''} potentielle${matches.length > 1 ? 's' : ''} pour votre entreprise :\n\n`;
        
        matches.forEach(match => {
            matchMessage += `- ${match.company.name}\n`;
            
            if (match.details.theyProvide.length > 0) {
                matchMessage += `  Ils peuvent vous fournir : ${match.details.theyProvide.join(', ')}\n`;
            }
            
            if (match.details.weProvide.length > 0) {
                matchMessage += `  Vous pouvez leur fournir : ${match.details.weProvide.join(', ')}\n`;
            }
            
            matchMessage += '\n';
        });
        
        matchMessage += 'Connectez-vous √† votre profil pour voir les d√©tails et contacter ces entreprises.';
        
        alert(matchMessage);
    }
};

// Cr√©er une banni√®re de notifications sur la page d'accueil pour montrer les nouveaux matchs
function createMatchesBanner() {
    const email = localStorage.getItem('currentLoggedIn');
    if (!email) return;
    
    // V√©rifier si la banni√®re existe d√©j√†
    if (document.getElementById('matches-banner')) return;
    
    // Trouver l'√©l√©ment o√π ins√©rer la banni√®re
    const introSection = document.getElementById('intro');
    if (!introSection) return;
    
    // R√©cup√©rer les correspondances actuelles
    const currentMatches = findMatchesForCompany(email, false); // Ne pas mettre √† jour l'historique
    
    if (currentMatches.length === 0) return; // Ne rien afficher s'il n'y a pas de correspondances
    
    // Cr√©er la banni√®re
    const banner = document.createElement('div');
    banner.id = 'matches-banner';
    banner.style.backgroundColor = '#FDF5E8';
    banner.style.border = '3px solid #E76F51';
    banner.style.borderRadius = '8px';
    banner.style.padding = '15px 20px';
    banner.style.margin = '0 auto 30px auto';
    banner.style.maxWidth = '1000px';
    
    const headerDiv = document.createElement('div');
    headerDiv.style.display = 'flex';
    headerDiv.style.justifyContent = 'space-between';
    headerDiv.style.alignItems = 'center';
    headerDiv.style.marginBottom = '15px';
    
    const title = document.createElement('h3');
    title.textContent = 'üîÑ Nouvelles correspondances d√©tect√©es !';
    title.style.margin = '0';
    title.style.color = '#E76F51';
    
    const viewAllBtn = document.createElement('button');
    viewAllBtn.className = 'add-category-btn';
    viewAllBtn.textContent = 'Voir toutes';
    viewAllBtn.onclick = function() {
        openModal('profileModal');
        loadProfileData();
    };
    
    headerDiv.appendChild(title);
    headerDiv.appendChild(viewAllBtn);
    banner.appendChild(headerDiv);
    
    // Afficher les 3 premi√®res correspondances uniquement
    const matchesToShow = currentMatches.slice(0, 3);
    
    matchesToShow.forEach((match, idx) => {
        const matchDiv = document.createElement('div');
        matchDiv.style.padding = '10px';
        matchDiv.style.backgroundColor = idx % 2 === 0 ? '#fff' : '#f8f8f8';
        matchDiv.style.borderRadius = '4px';
        matchDiv.style.marginBottom = '10px';
        
        const matchText = document.createElement('p');
        matchText.style.margin = '0';
        
        let matchDescription = `<strong>${match.company.name}</strong> : `;
        
        let categories = [];
        if (match.details.theyProvide.length > 0) {
            categories.push(`Ils peuvent vous fournir <span style="color:#E76F51">${match.details.theyProvide.join(', ')}</span>`);
        }
        
        if (match.details.weProvide.length > 0) {
            categories.push(`Vous pouvez leur fournir <span style="color:#2A9D8F">${match.details.weProvide.join(', ')}</span>`);
        }
        
        matchText.innerHTML = matchDescription + categories.join(' et ');
        matchDiv.appendChild(matchText);
        banner.appendChild(matchDiv);
    });
    
    // Si plus de 3 correspondances, indiquer "et plus..."
    if (currentMatches.length > 3) {
        const moreText = document.createElement('p');
        moreText.textContent = `Et ${currentMatches.length - 3} autre(s) correspondance(s)...`;
        moreText.style.textAlign = 'center';
        moreText.style.fontStyle = 'italic';
        moreText.style.margin = '5px 0 0 0';
        banner.appendChild(moreText);
    }
    
    // Ins√©rer avant la premi√®re section
    introSection.parentNode.insertBefore(banner, introSection);
}

// Initialiser au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    // Code pr√©c√©dent d√©j√† pr√©sent
    populateCategoryDropdowns();
    
    // Mettre √† jour les placeholders
    const resourcesPlaceholder = document.getElementById('resources');
    if (resourcesPlaceholder) {
        resourcesPlaceholder.placeholder = "Exemples : 2h de conseil en strat√©gie durable par mois, atelier de m√©ditation hebdomadaire, 15kg de carton recycl√© chaque semaine, salle de r√©union disponible les vendredis...";
    }
    
    const needsPlaceholder = document.getElementById('needs');
    if (needsPlaceholder) {
        needsPlaceholder.placeholder = "Exemples : Recherche expertise en marketing digital (2h/mois), besoin de palettes en bois, espace de stockage temporaire, formation en comptabilit√©...";
    }
    
    // V√©rifier si un utilisateur est connect√©
    const email = localStorage.getItem('currentLoggedIn');
    if (email) {
        // Cr√©er la banni√®re de matchs sur la page d'accueil
        createMatchesBanner();
    }
});
